<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNG Connect Global</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <style>
        :root { --bg: #0b141a; --panel: #202c33; --green: #00a884; --white: #e9edef; --text-gray: #8696a0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--white); margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .app-bar { background: var(--panel); padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; z-index: 100; }
        .screen { display: none; height: 100%; overflow-y: auto; padding-bottom: 80px; box-sizing: border-box; }
        .active-screen { display: block; }

        /* –≠–∫—Ä–∞–Ω–∏ –ß–∞—Ç“≥–æ */
        .chat-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 0.5px solid #222; cursor: pointer; }
        .avatar { width: 50px; height: 50px; background: #3d474c; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--green); overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–∏ –ß–∞—Ç */
        #individualChat { position: fixed; inset: 0; background: var(--bg); display: none; flex-direction: column; z-index: 1000; }
        #messageList { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 75%; font-size: 15px; position: relative; }
        .sent { background: #005c4b; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: var(--panel); align-self: flex-start; border-bottom-left-radius: 2px; }
        
        /* –ú–µ–¥–∏–∞ –¥–∞—Ä —á–∞—Ç */
        .msg img, .msg video { width: 200px; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer; display: block; margin-bottom: 5px; }
        
        .input-area { background: var(--panel); padding: 10px; display: flex; align-items: center; gap: 10px; }
        .input-area input { flex: 1; background: #2a3942; border: none; padding: 12px; color: white; border-radius: 25px; outline: none; }

        /* –ó–∞–Ω–≥ (Full Screen) */
        #callOverlay { position: fixed; inset: 0; background: #000; z-index: 9000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; background: #222; border-radius: 10px; object-fit: cover; border: 2px solid var(--green); }
        .call-ui { position: absolute; bottom: 50px; display: flex; gap: 30px; z-index: 9001; }
        .btn-call { width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 25px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* –ù–∞–≤–∏–≥–∞—Ç—Å–∏—è */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--panel); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; }
        .nav-item { text-align: center; color: var(--text-gray); font-size: 12px; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--green); }
        .nav-item b { display: block; font-size: 20px; }

        /* Full Screen Image Viewer */
        #fullViewer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: none; align-items: center; justify-content: center; }
        #fullViewer img, #fullViewer video { max-width: 95%; max-height: 90%; }

        .btn-main { background: var(--green); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="callOverlay">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
    <div id="callInfo" style="position:absolute; top:100px; text-align:center; width:100%;">
        <h2 id="callerName">–ó–∞–Ω–≥...</h2>
    </div>
    <div class="call-ui">
        <button id="answerBtn" class="btn-call" style="background: #2ecc71;" onclick="acceptCall()">üìû</button>
        <button class="btn-call" style="background: #e74c3c;" onclick="endCall()">üõë</button>
    </div>
</div>

<div id="loginScreen" style="position:fixed; inset:0; background:var(--bg); z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
    <h1 style="color:var(--green)">SNG Connect</h1>
    <input type="number" id="myNum" placeholder="–†–∞“õ–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω (–º–∞—Å–∞–ª–∞–Ω 900112233)" style="width:100%; max-width:300px; padding:15px; background:#2a3942; border:none; color:white; border-radius:10px; margin-bottom:15px;">
    <button onclick="register()" class="btn-main" style="max-width:300px;">–î–∞—Ä–æ–º–∞–¥–∞–Ω</button>
</div>

<div class="app-bar">
    <span id="screenTitle">–ß–∞—Ç“≥–æ</span>
    <span style="color: var(--green);">SNG</span>
</div>

<div id="screen-chats" class="screen active-screen">
    <div id="chatListContainer"></div>
    <button onclick="addFriend()" style="position:fixed; bottom:80px; right:20px; width:60px; height:60px; border-radius:50%; background:var(--green); border:none; color:white; font-size:30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">+</button>
</div>

<div id="screen-stories" class="screen">
    <div class="chat-item" onclick="document.getElementById('storyInp').click()">
        <div class="avatar" style="border: 2px dashed var(--green); background:none;">+</div>
        <div><b>–°—Ç–æ—Ä–∏–∑–∏ –º–∞–Ω</b><br><small>–ê–∫—Å —ë –≤–∏–¥–µ–æ –∏–ª–æ–≤–∞ –∫—É–Ω–µ–¥</small></div>
        <input type="file" id="storyInp" hidden accept="image/*,video/*" onchange="postStory(this)">
    </div>
    <div id="storiesList"></div>
</div>

<div id="screen-settings" class="screen" style="padding:20px;">
    <div class="chat-item" style="background:var(--panel); border-radius:15px; border:none;">
        <div class="avatar" id="myAvatar">U</div>
        <div><b id="myName">–ö–æ—Ä–±–∞—Ä</b><br><small id="myPhoneDisplay"></small></div>
    </div>
    <button onclick="logout()" class="btn-main" style="background:#e91e63; margin-top:20px;">üö™ –ë–∞—Ä–æ–º–∞–¥</button>
</div>

<div id="individualChat">
    <div class="app-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="backToChats()" style="background:none; border:none; color:var(--green); font-size:20px;">‚¨ÖÔ∏è</button>
            <span id="chatWithTitle">–ù–æ–º</span>
        </div>
        <div style="display:flex; gap:15px;">
            <button onclick="initiateCall('audio')" style="background:none; border:none; font-size:20px;">üìû</button>
            <button onclick="initiateCall('video')" style="background:none; border:none; font-size:20px;">üìπ</button>
        </div>
    </div>
    <div id="messageList"></div>
    <div class="input-area">
        <button onclick="toggleVoice()" id="voiceBtn" style="background:none; border:none; font-size:22px;">üéôÔ∏è</button>
        <button onclick="document.getElementById('fileInp').click()" style="background:none; border:none; font-size:22px;">üìé</button>
        <input type="file" id="fileInp" hidden accept="image/*,video/*" onchange="sendMedia(this)">
        <input type="text" id="mInput" placeholder="–ü–∞—ë–º...">
        <button onclick="sendMsg()" style="background:none; border:none; font-size:22px; color:var(--green);">‚û°Ô∏è</button>
    </div>
</div>

<div id="fullViewer" onclick="this.style.display='none'"></div>

<div class="nav-bar">
    <div class="nav-item active" onclick="showScreen('screen-chats', '–ß–∞—Ç“≥–æ', this)"><b>üí¨</b>–ß–∞—Ç“≥–æ</div>
    <div class="nav-item" onclick="showScreen('screen-stories', '–°—Ç–æ—Ä–∏–∑', this)"><b>‚≠ï</b>–°—Ç–æ—Ä–∏–∑</div>
    <div class="nav-item" onclick="showScreen('screen-settings', '–¢–∞–Ω–∑–∏–º–æ—Ç', this)"><b>‚öôÔ∏è</b>–¢–∞–Ω–∑–∏–º–æ—Ç</div>
</div>

<script>
    // --- –¢–ê–ù–ó–ò–ú–û–¢ –í–ê –ü–ê–ô–í–ê–°–¢–®–ê–í”¢ ---
    const socket = io('https://your-server.onrender.com'); // –õ–∏–Ω–∫–∏ Render-—Ä–æ –∏–Ω“∑–æ –≥—É–∑–æ—Ä–µ–¥
    let myPhone = localStorage.getItem('tj_phone') || "";
    let activeChatPhone = "";
    let peer, localStream;
    let mediaRecorder, audioChunks = [];

    const iceConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

    function register() {
        const num = document.getElementById('myNum').value;
        if(num.length < 5) return alert("–†–∞“õ–∞–º —Ö–∞—Ç–æ—Å—Ç!");
        myPhone = num;
        localStorage.setItem('tj_phone', num);
        socket.emit('register', num);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('myPhoneDisplay').innerText = "+" + num;
        loadFriends();
    }

    // --- –ß–ê–¢ –í–ê –ú–ï–î–ò–ê ---
    function sendMsg() {
        const val = document.getElementById('mInput').value;
        if(!val) return;
        const msgData = { toPhone: activeChatPhone, data: val, type: 'text', fromPhone: myPhone };
        socket.emit('message', msgData);
        appendMsg(val, 'sent', 'text');
        document.getElementById('mInput').value = "";
    }

    function sendMedia(input) {
        const file = input.files[0];
        const type = file.type.startsWith('image') ? 'image' : 'video';
        const reader = new FileReader();
        reader.onload = (e) => {
            socket.emit('message', { toPhone: activeChatPhone, data: e.target.result, type: type, fromPhone: myPhone });
            appendMsg(e.target.result, 'sent', type);
        };
        reader.readAsDataURL(file);
    }

    async function toggleVoice() {
        const btn = document.getElementById('voiceBtn');
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const r = new FileReader();
                r.onloadend = () => {
                    socket.emit('message', { toPhone: activeChatPhone, data: r.result, type: 'voice', fromPhone: myPhone });
                    appendMsg(r.result, 'sent', 'voice');
                };
                r.readAsDataURL(blob);
            };
            mediaRecorder.start(); btn.innerText = "üõë";
        } else { mediaRecorder.stop(); btn.innerText = "üéôÔ∏è"; }
    }

    function appendMsg(data, side, type) {
        const list = document.getElementById('messageList');
        const d = document.createElement('div');
        d.className = `msg ${side}`;
        
        if(type === 'image') d.innerHTML = `<img src="${data}" onclick="viewFull('${data}', 'img')">`;
        else if(type === 'video') d.innerHTML = `<video src="${data}" onclick="viewFull('${data}', 'vid')"></video>`;
        else if(type === 'voice') d.innerHTML = `<audio src="${data}" controls style="width:200px;"></audio>`;
        else d.innerText = data;

        list.appendChild(d);
        list.scrollTop = list.scrollHeight;
    }

    // --- –ó–ê–ù–ì“≤–û–ò –ì–õ–û–ë–ê–õ”¢ (WebRTC) ---
    async function initiateCall(type) {
        document.getElementById('callOverlay').style.display = 'flex';
        document.getElementById('answerBtn').style.display = 'none';
        document.getElementById('callerName').innerText = "–ó–∞–Ω–≥ –±–∞ " + activeChatPhone;

        localStream = await navigator.mediaDevices.getUserMedia({ video: type==='video', audio: true });
        document.getElementById('localVideo').srcObject = localStream;

        peer = new SimplePeer({ initiator: true, trickle: false, stream: localStream, config: iceConfig });
        
        peer.on('signal', data => {
            socket.emit('call-request', { toPhone: activeChatPhone, fromPhone: myPhone, signal: data, type: type });
        });

        peer.on('stream', stream => {
            document.getElementById('remoteVideo').srcObject = stream;
        });
    }

    socket.on('incoming-call', async (data) => {
        window.incomingCallData = data;
        document.getElementById('callOverlay').style.display = 'flex';
        document.getElementById('answerBtn').style.display = 'flex';
        document.getElementById('callerName').innerText = "–ó–∞–Ω–≥–∏ –¥–∞—Ä–æ–º–∞–¥: " + data.fromPhone;
    });

    async function acceptCall() {
        document.getElementById('answerBtn').style.display = 'none';
        const type = window.incomingCallData.type;
        localStream = await navigator.mediaDevices.getUserMedia({ video: type==='video', audio: true });
        document.getElementById('localVideo').srcObject = localStream;

        peer = new SimplePeer({ initiator: false, trickle: false, stream: localStream, config: iceConfig });
        
        peer.on('signal', data => {
            socket.emit('call-answer', { toPhone: window.incomingCallData.fromPhone, signal: data });
        });

        peer.on('stream', stream => {
            document.getElementById('remoteVideo').srcObject = stream;
        });

        peer.signal(window.incomingCallData.signal);
    }

    function endCall() {
        if(peer) peer.destroy();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('callOverlay').style.display = 'none';
        socket.emit('end-call', { toPhone: activeChatPhone || window.incomingCallData?.fromPhone });
    }

    socket.on('call-answered', d => peer.signal(d.signal));
    socket.on('call-ended', () => endCall());

    // --- –°–¢–û–†–ò–ó ---
    function postStory(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            let stories = JSON.parse(localStorage.getItem('my_stories') || '[]');
            stories.push({ id: Date.now(), data: e.target.result, type: file.type.split('/')[0] });
            localStorage.setItem('my_stories', JSON.stringify(stories));
            loadStories();
        };
        reader.readAsDataURL(file);
    }

    function loadStories() {
        const list = document.getElementById('storiesList');
        list.innerHTML = "";
        const stories = JSON.parse(localStorage.getItem('my_stories') || '[]');
        stories.forEach(s => {
            const d = document.createElement('div');
            d.className = 'chat-item';
            d.innerHTML = `<div class="avatar" style="border:2px solid var(--green)">${s.type === 'image' ? `<img src="${s.data}">` : 'üìπ'}</div><div><b>–°—Ç–æ—Ä–∏–∑–∏ –º–∞–Ω</b><br><small>“≤–æ–∑–∏—Ä</small></div>`;
            d.onclick = () => viewFull(s.data, s.type === 'image' ? 'img' : 'vid');
            list.appendChild(d);
        });
    }

    // --- –î–ò–ì–ê–† –§–£–ù–ö–°–ò–Ø“≤–û ---
    function addFriend() {
        const p = prompt("–†–∞“õ–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—Ä–æ –Ω–∞–≤–∏—Å–µ–¥:");
        const n = prompt("–ù–æ–º–∏ –¥”Ø—Å—Ç:");
        if(p && n) {
            let f = JSON.parse(localStorage.getItem('my_friends') || '[]');
            f.push({ name: n, phone: p });
            localStorage.setItem('my_friends', JSON.stringify(f));
            loadFriends();
        }
    }

    function loadFriends() {
        const cont = document.getElementById('chatListContainer');
        cont.innerHTML = "";
        const friends = JSON.parse(localStorage.getItem('my_friends') || '[]');
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.innerHTML = `<div class="avatar">${f.name[0]}</div><div><b>${f.name}</b><br><small>${f.phone}</small></div>`;
            div.onclick = () => {
                activeChatPhone = f.phone;
                document.getElementById('individualChat').style.display = 'flex';
                document.getElementById('chatWithTitle').innerText = f.name;
            };
            cont.appendChild(div);
        });
    }

    function viewFull(src, type) {
        const v = document.getElementById('fullViewer');
        v.style.display = 'flex';
        v.innerHTML = type === 'img' ? `<img src="${src}">` : `<video src="${src}" controls autoplay></video>`;
    }

    function showScreen(id, title, el) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.getElementById(id).classList.add('active-screen');
        document.getElementById('screenTitle').innerText = title;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function backToChats() { document.getElementById('individualChat').style.display = 'none'; }
    function logout() { localStorage.clear(); location.reload(); }

    window.onload = () => { if(myPhone) { document.getElementById('loginScreen').style.display='none'; document.getElementById('myPhoneDisplay').innerText = "+" + myPhone; socket.emit('register', myPhone); loadFriends(); loadStories(); } };
    socket.on('message', d => { if(d.fromPhone === activeChatPhone) appendMsg(d.data, 'received', d.type); });
</script>
</body>
</html>
